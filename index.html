<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Incident Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+4Fj8ETbdrU0s8QnE7FqzLMd6Bj4uP7t1HjQj6RkA="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1jzN3xv6xBz06vE4N2rQ6YxSgA5WQ9XZp3kzH4ik="
    crossorigin=""
  ></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      background-color: #f8f9fa;
      overflow: hidden;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    .leaflet-container {
      cursor: default !important; /* ðŸ‘ˆ normal arrow, no hand symbol */
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    // === Initialize Map ===
    const map = L.map("map", {
      center: [24.7, 46.7],
      zoom: 6,
      zoomControl: true,
    });

    // === Base Tile Layer ===
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap contributors",
      maxZoom: 18,
    }).addTo(map);

    // Store globally for reuse
    window.map = map;
    window.markersLayer = L.layerGroup().addTo(map);

    // === Receive data from Grafana ===
    window.addEventListener("message", (event) => {
      const data = event.data;
      if (!data || data.type !== "incidentData") return;

      console.log("âœ… Received incident data:", data);

      // Clear old markers
      if (window.markersLayer) {
        window.markersLayer.clearLayers();
      }

      // Add new markers
      data.data.forEach((d) => {
        const decodedName = decodeURIComponent(d.state);
        const marker = L.circleMarker([d.lat, d.long], {
          radius: 10, // ðŸ‘ˆ Bigger blue dot
          color: "#0055ff",
          fillColor: "#3388ff",
          fillOpacity: 0.8,
          weight: 1,
        }).addTo(window.markersLayer);

        marker.bindTooltip(`${decodedName}<br>Count: ${d.count}`, {
          permanent: false,
          direction: "top",
        });

        // Send click info back to Grafana
        marker.on("click", () => {
          window.parent.postMessage(
            {
              type: "mapClick",
              state: d.state,
              lat: d.lat,
              long: d.long,
              count: d.count,
              label: decodedName,
            },
            "*"
          );
        });
      });

      console.log("âœ… Markers added:", data.data.length);
    });

    // === Safety: prevent hand cursor ===
    map.on("mousemove", () => {
      document.body.style.cursor = "default";
    });
  </script>
</body>
</html>
