<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clustered Incident Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100%; }
    .selected-marker {
      filter: hue-rotate(180deg) brightness(1.5);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script>
    const map = L.map('map').setView([25, 45], 6); // Center on Saudi Arabia
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18
    }).addTo(map);

    // === Get Grafana Query Data ===
    const series = context?.panel?.data?.series ?? [];
    if (!series.length) {
      console.error("No data received from Grafana query");
    }

    const fields = series[0]?.fields ?? [];
    const latIndex = fields.findIndex(f => f.name.toLowerCase().includes("lat"));
    const lonIndex = fields.findIndex(f => f.name.toLowerCase().includes("lon"));
    const stateIndex = fields.findIndex(f => f.name.toLowerCase().includes("state"));
    const countIndex = fields.findIndex(f => f.name.toLowerCase().includes("counta"));

    const rows = [];
    const rowCount = fields[latIndex]?.values?.length ?? 0;
    for (let i = 0; i < rowCount; i++) {
      rows.push({
        lat: fields[latIndex].values.get(i),
        lon: fields[lonIndex].values.get(i),
        state: fields[stateIndex]?.values?.get(i),
        counta: fields[countIndex]?.values?.get(i)
      });
    }

    // === Cluster Layer ===
    const markers = L.markerClusterGroup({
      chunkedLoading: true, // boosts performance
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      maxClusterRadius: 60
    });

    let selectedMarker = null;

    rows.forEach(row => {
      if (!row.lat || !row.lon) return;
      const marker = L.marker([row.lat, row.lon]);
      marker.bindPopup(`<b>${row.state}</b><br>Count: ${row.counta}`);

      marker.on('click', function () {
        // === Handle selection ===
        if (selectedMarker === marker) {
          marker.getElement()?.classList.remove("selected-marker");
          selectedMarker = null;
          setGrafanaVar("PARENTLOCATIONNAME", "All"); // reset variable
        } else {
          if (selectedMarker?.getElement()) {
            selectedMarker.getElement().classList.remove("selected-marker");
          }
          selectedMarker = marker;
          marker.getElement()?.classList.add("selected-marker");
          setGrafanaVar("PARENTLOCATIONNAME", row.state);
        }
      });

      markers.addLayer(marker);
    });

    map.addLayer(markers);

    // === Update Grafana Variable (no refresh) ===
    async function setGrafanaVar(name, value) {
      const grafanaSrv = getLocationSrv();
      const variable = grafanaSrv.getVariables().find(v => v.name === name);
      if (variable) {
        variable.setValueFromUrl(value);
        console.log("Variable updated:", name, value);
      }
    }
  </script>
</body>
</html>
