
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Optimized Incident Map</title>

<!-- Leaflet + Clustering -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<style>
  html, body, #map {
    height: 100%;
    margin: 0;
    padding: 0;
  }
  .leaflet-marker-icon {
    cursor: default !important; /* Remove hand symbol */
  }
</style>
</head>
<body>
<div id="map"></div>

<!-- JS -->
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script>
  // === Map Setup ===
  const map = L.map('map', { preferCanvas: true }).setView([24.7136, 46.6753], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  // === Cluster Group (optimized) ===
  const markerCluster = L.markerClusterGroup({
    disableClusteringAtZoom: 9,
    chunkedLoading: false, // disable chunking for proper cluster grouping
    spiderfyOnMaxZoom: true,
    removeOutsideVisibleBounds: true
  });
  map.addLayer(markerCluster);

  // === Icons ===
  const blueIcon = L.icon({
    iconUrl: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
    iconSize: [32, 32],
    iconAnchor: [16, 32]
  });

  const yellowIcon = L.icon({
    iconUrl: "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png",
    iconSize: [32, 32],
    iconAnchor: [16, 32]
  });

  // === Data State ===
  let markerDataMap = new Map();
  let currentDataHash = null;
  let selectedMarker = null;
  let initialViewSet = false;

  // === Generate a data hash to detect updates ===
  function generateDataHash(data) {
    if (!data || !data.lat) return null;
    return data.lat.length + "_" + data.lat[0] + "_" + data.long[0];
  }

  // === Add all markers at once (much faster + proper clustering) ===
  function addAllMarkers(data) {
    const markers = [];
    markerDataMap.clear();

    for (let i = 0; i < data.lat.length; i++) {
      const lat = parseFloat(data.lat[i]);
      const lng = parseFloat(data.long[i]);
      if (isNaN(lat) || isNaN(lng)) continue;

      const state = decodeURIComponent(data.state[i]);
      const count = data.count[i];
      const markerId = `${lat}_${lng}`;

      const marker = L.marker([lat, lng], { icon: blueIcon });
      marker.bindPopup(`${state}<br>Count: ${count}`);

      markerDataMap.set(markerId, { state, lat, lng, count, marker });
      marker.on("click", () => handleMarkerClick(markerId));
      markers.push(marker);
    }

    // Add all at once for instant cluster creation
    markerCluster.addLayers(markers);
    console.log(`âœ… Added ${markers.length} markers with clustering.`);

    // Fit bounds *after* markers fully added
    if (!initialViewSet && markers.length > 0) {
      const groupBounds = L.latLngBounds(markers.map(m => m.getLatLng()));
      map.fitBounds(groupBounds, { padding: [30, 30] });
      initialViewSet = true;
    }
  }

  // === Marker Click (toggle colors + update variables) ===
  function handleMarkerClick(markerId) {
    const data = markerDataMap.get(markerId);
    if (!data) return;

    const marker = data.marker;

    if (selectedMarker === marker) {
      marker.setIcon(blueIcon);
      selectedMarker = null;

      window.parent.postMessage({
        type: "mapVariableReset",
        LOCATIONNAME: "All",
        Latitude: "All",
        Longitude: "All"
      }, "*");
    } else {
      if (selectedMarker) selectedMarker.setIcon(blueIcon);
      marker.setIcon(yellowIcon);
      selectedMarker = marker;

      window.parent.postMessage({
        type: "mapVariableUpdate",
        LOCATIONNAME: data.state,
        Latitude: data.lat,
        Longitude: data.lng
      }, "*");
    }
  }

  // === Listen for incoming Grafana data ===
  window.addEventListener("message", (event) => {
    const data = event.data;
    if (!data || !data.lat || !data.long || !data.state) return;

    const newHash = generateDataHash(data);
    if (newHash === currentDataHash) return;
    currentDataHash = newHash;

    // Preserve current view
    const center = map.getCenter();
    const zoom = map.getZoom();

    // Clear previous data
    markerCluster.clearLayers();
    markerDataMap.clear();
    selectedMarker = null;

    addAllMarkers(data);

    // Keep map stable after first load
    if (initialViewSet) {
      map.setView(center, zoom, { animate: false });
    }
  });

  console.log("ðŸš€ Map ready â€” waiting for Grafana data...");
</script>
</body>
</html>
