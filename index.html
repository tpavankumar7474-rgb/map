<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Incident Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<style>
  html, body, #map { height: 100%; margin: 0; padding: 0; }
  .leaflet-container {
    cursor: default !important;
  }
  .leaflet-marker-icon {
    cursor: pointer !important; /* Pointer only on marker */
  }
</style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script>
const map = L.map('map', {
  zoomSnap: 0.25,
  zoomDelta: 0.25,
  maxZoom: 18,
  minZoom: 3
}).setView([24.7, 46.7], 6);

// Add OpenStreetMap tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Initialize cluster group
let clusterGroup = L.markerClusterGroup({ chunkedLoading: true });
map.addLayer(clusterGroup);

// === Custom blue icon (bigger size)
const blueIcon = L.divIcon({
  html: `<div style="width:16px;height:16px;background:#007bff;border-radius:50%;border:2px solid white;"></div>`,
  className: "",
  iconSize: [16, 16]
});

// === Highlight (yellow) icon
const yellowIcon = L.divIcon({
  html: `<div style="width:20px;height:20px;background:yellow;border-radius:50%;border:3px solid #333;"></div>`,
  className: "",
  iconSize: [20, 20]
});

let selectedMarker = null;

// === Handle incoming data from Grafana
window.addEventListener("message", (event) => {
  if (!event.data || event.data.type !== "incidentData") return;

  const incidents = event.data.data;
  clusterGroup.clearLayers();

  incidents.forEach(d => {
    const marker = L.marker([d.lat, d.lon], { icon: blueIcon });

    marker.bindPopup(`<b>${decodeURIComponent(d.state)}</b><br>Count: ${d.count}`);

    marker.on("click", () => {
      // Toggle highlight
      if (selectedMarker === marker) {
        // Deselect
        marker.setIcon(blueIcon);
        selectedMarker = null;
        // Send reset variable (All)
        window.parent.postMessage({
          type: "mapClick",
          state: "All",
          label: "All",
          count: 0
        }, "*");
      } else {
        // Reset old selection
        if (selectedMarker) selectedMarker.setIcon(blueIcon);
        // Highlight new one
        marker.setIcon(yellowIcon);
        selectedMarker = marker;

        // Send selected location to Grafana
        window.parent.postMessage({
          type: "mapClick",
          state: d.state,
          label: decodeURIComponent(d.state),
          count: d.count
        }, "*");
      }
    });

    clusterGroup.addLayer(marker);
  });

  console.log(`âœ… ${incidents.length} markers loaded`);
});
</script>
</body>
</html>
