<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Saudi Arabia Incident Map</title>

    <!-- Leaflet & Cluster CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"
    />

    <style>
      html,
      body,
      #map {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      .leaflet-tooltip {
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 13px;
        padding: 5px 8px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <!-- Leaflet & Cluster JS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
      console.log("‚úÖ Map initializing...");

      // Create base map centered on Saudi Arabia
      const map = L.map("map").setView([23.8859, 45.0792], 6);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "¬© OpenStreetMap contributors",
      }).addTo(map);

      const clusterGroup = L.markerClusterGroup();
      map.addLayer(clusterGroup);

      // Store marker info
      let markerDataMap = new Map();

      // --- Function to send variable updates to Grafana parent ---
      function sendVariableUpdate(variableName, variableValue) {
        const payload = {
          type: "updateVariable",
          variable: variableName,
          value: variableValue,
        };
        console.log("üõ∞Ô∏è Sending variable update:", payload);
        window.parent.postMessage(payload, "*");
      }

      // --- Listen for incoming data from Grafana ---
      window.addEventListener("message", (event) => {
        const data = event.data;
        console.log("üì© Received message from parent:", data);

        if (!data || !data.incidentData) {
          console.warn("‚ö†Ô∏è No incidentData found in message");
          return;
        }

        const arr = data.incidentData;
        clusterGroup.clearLayers();
        markerDataMap.clear();

        let bounds = [];

        arr.forEach((d) => {
          const { state, lat, long, count } = d;
          if (lat == null || long == null) return;

          // Tooltip HTML
          const tooltip = `
            <strong>Location:</strong> ${state}<br/>
            <strong>Lat:</strong> ${lat}<br/>
            <strong>Long:</strong> ${long}<br/>
            <strong>Count:</strong> ${count}
          `;

          const marker = L.marker([lat, long], { title: state });
          marker.bindTooltip(tooltip, {
            direction: "top",
            permanent: false,
            opacity: 0.9,
          });

          // --- On marker click ---
          marker.on("click", () => {
            const payload = {
              type: "mapClick",
              state,
              lat,
              long,
              count,
              label: state,
            };
            console.log("üìç Marker clicked:", payload);

            // Send generic click message
            window.parent.postMessage(payload, "*");

            // Delay variable update to prevent iframe reload
            setTimeout(() => {
              sendVariableUpdate("LOCATIONNAME", state);
            }, 500);
          });

          clusterGroup.addLayer(marker);
          bounds.push([lat, long]);
        });

        // Fit map to all markers
        if (bounds.length > 0) {
          const b = L.latLngBounds(bounds);
          map.fitBounds(b, { padding: [40, 40] });
        }
      });

      // --- Cluster click (popup only, no variable update) ---
      clusterGroup.on("clusterclick", (a) => {
        const markers = a.layer.getAllChildMarkers();
        if (markers.length > 0) {
          const first = markers[0].getLatLng();
          const popup = `
            <strong>Cluster size:</strong> ${markers.length}<br/>
            <strong>First location:</strong> ${markers[0].options.title}<br/>
            <strong>Lat:</strong> ${first.lat.toFixed(4)}<br/>
            <strong>Long:</strong> ${first.lng.toFixed(4)}
          `;
          L.popup().setLatLng(a.latlng).setContent(popup).openOn(map);
          console.log("üß© Cluster clicked (popup only)");
        }
      });

      console.log("üåç Map loaded and waiting for data...");
    </script>
  </body>
</html>
